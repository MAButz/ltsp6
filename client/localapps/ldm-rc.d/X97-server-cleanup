# At this point the user session has exited (or X has crashed) but user
# processes might still be running on both the client and the server.
# Do only the server-side cleanup here, because LDM closes the ssh socket at
# the end of the X* phase.
# The rest of the cleanup will be done in the K* phase, after X and hopefully
# all client-side user processes have been terminated.

# TODO: this script, and any other server-side cleanup functionality, should be
# replaced by an "ltsp-session" server-side script, which would ensure that the
# server-side cleanup is executed even if the client is disconnected or powered
# off. That "ltsp-session" script might even be generated client-side and
# copied to the server via scp.

if boolean_is_true "$LOCAL_APPS"; then
    # Clean up localapps menu
    if boolean_is_true "$LOCAL_APPS_MENU" && [ -n "$TMP_XDG_MENU" ]; then
        if [ -S "$LDM_SOCKET" ]; then
            ssh -S "$LDM_SOCKET" "$LDM_SERVER" rm -rf "$TMP_XDG_MENU"
        fi
    fi
fi
